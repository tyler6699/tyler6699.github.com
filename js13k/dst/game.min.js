var context=new AudioContext,o=null,g=null;function playSound(t){for(m=context.createBuffer(1,96e3,48e3),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=context.createBufferSource(),s.buffer=m,s.connect(context.destination),s.start()}function getNoise(t){return 2*Math.random()-1}function getJump(t){if(1e4<t)return null;var e=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(e,2)}function getFall(t){if(5e4<t)return null;var e=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(e,3)}function getCoin(t){var e=1e4;if(e<t)return null;var i=(e-t)/e,n=Math.pow(i,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?n:-n}function Camera(t,e){this.entity=new entityObj(30,30,"null",t,e,"view"),this.newPos=function(t,e){this.entity.x=parseInt(t.entity.x+t.entity.width/2-e.canvasHalfW),this.entity.y=t.entity.y+t.entity.height/2-e.canvasHalfH-offset}}function entityObj(t,e,i,n,s,a){this.type=a,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.hWidth=t/2,this.hHeight=e/2,this.angle=0,this.x=n,this.y=s,this.color=i,this.active=!0,this.update=function(){this.active&&(ctx=mainGame.context,ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(this.angle),ctx.fillStyle=this.color,ctx.fillRect(this.mhWidth,this.mhHeight,this.width,this.height),ctx.restore())}}function heroObj(e,n,s,a,h,r){this.entity=new entityObj(e,n,s,a,h,"hero"),this.speed=1,this.color=s,this.startX=a,this.startY=h,this.currentLevel=1,this.active=!1,this.reset=!1;var o=0,c=0,l=!1;function y(){hero.hbX=hero.entity.x+hero.entity.hWidth,hero.hbY=hero.entity.y+hero.entity.hHeight/2}this.update=function(t){ctx=mainGame.context,ctx.save(),ctx.translate(this.entity.x-t.entity.x,this.entity.y-t.entity.y),ctx.fillStyle=s,ctx.fillRect(this.entity.mhWidth,this.entity.mhHeight,this.entity.width,this.entity.height),ctx.restore()},this.newPos=function(e){this.hbX1=this.entity.x,this.hbY1=this.entity.y,y();var n=this.entity.x+o*this.speed,s=this.entity.y+6-c;0<c&&c--;var a=!0,h=!0;for(i=0;i<e.length;i++)t=e[i],t.isSolid&&t.active&&(rectColiding(n,this.hbY1,this.entity.width,this.entity.height,t.entity.x,t.entity.y,t.entity.width,t.entity.height)&&(h=!1),rectColiding(this.hbX1,s,this.entity.width,this.entity.height,t.entity.x,t.entity.y,t.entity.width,t.entity.height)&&(a=!1));l=!a,h&&(this.entity.x=n),a&&(this.entity.y=s),400<this.entity.y&&(playSound(FALLFX),this.entity.y=this.startY,this.entity.x=this.startX,this.reset=!0)},this.tick=function(){0<o?(o-=.3)<0&&(o=0):o<0&&0<(o+=.3)&&(o=0),mainGame.keys&&!this.jumping&&(mainGame.keys[UP]||mainGame.keys[W]||mainGame.keys[SPACE])&&0==c&&1==l&&(c=19,playSound(JUMPFX)),mainGame.keys&&(mainGame.keys[DOWN]||mainGame.keys[S]),mainGame.keys&&(mainGame.keys[LEFT]||mainGame.keys[A])&&-3<o&&o--,mainGame.keys&&(mainGame.keys[RIGHT]||mainGame.keys[D])&&o<3&&o++,0<controllers.length&&((controllers[0].axes[0]<-.8||controllers[0].axes[2]<-.8||controllers[0].buttons[14].pressed)&&-3<o&&o--,(.8<controllers[0].axes[0]||.8<controllers[0].axes[2]||controllers[0].buttons[15].pressed)&&o<3&&o++,(controllers[0].axes[1]<-.8||controllers[0].axes[3]<-.8||controllers[0].buttons[12].pressed)&&0==c&&1==l&&(c=19,jumpSFX.play()),.8<controllers[0].axes[1]||.8<controllers[0].axes[3]||controllers[0].buttons[13].pressed)},this.resetPos=function(t,e){hero.startX=t,hero.startY=e,hero.entity.x=hero.startX,hero.entity.y=hero.startY,y(),hero.hPower=0,hero.jumping=!1,hero.active=!0}}getSound=function(t,e){var i;switch(t){case NOISEFX:i=getNoise(e);break;case COINFX:i=getCoin(e);break;case JUMPFX:i=getJump(e);break;case FALLFX:i=getFall(e);break;default:return 1}return i};var LEFT=37,RIGHT=39,UP=38,DOWN=40,W=87,A=65,S=83,D=68,LMB=0,RMB=2,SPACE=32,WALL=0,BRICK=1,COIN=2,HERO=3,LEDGE=4,ICE=5,NOISEFX=0,COINFX=1,JUMPFX=2,FALLFX=3;function level(t,e,n){this.tiles=[],this.backTiles=[],this.coins=[],this.startX=0,this.startY=0,this.canvasHalfW=t/2,this.canvasHalfH=e/2;var h,r=0,o=0;this.draw=function(t,e){for(i=0;i<this.backTiles.length;i++){(n=this.backTiles[i]).update(e)}for(i=0;i<this.tiles.length;i++){var n;(n=this.tiles[i]).update(e),n.tick(t)}for(i=0;i<this.coins.length;i++){var s=this.coins[i];s.update(e),heroColliding(s)&&this.active&&s.active&&(playSound(COINFX),s.active=!1,r++)}r==o?(t.currentLevel++,t.active=!1,this.active=!1,this.reset(t.currentLevel,t)):t.reset&&(t.reset=!1,t.active=!1,this.active=!1,this.reset(t.currentLevel,t))},this.reset=function(t,e){r=o=0,this.tiles=[],this.backTiles=[],this.coins=[],1==t?h=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,4,4,4,4,4,0,0,0,0,0,0],[4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,0,0,0,0,0,2,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,4,4,0,0,1,1,1,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,2,0,0,0,1],[1,0,0,1,1,1,0,0,1,0,3,0,1,1,1,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1],[1,4,4,4,4,4,4,4,1,4,4,4,4,5,5,5,5,5,4,1]]:2==t?h=[[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,3,0,0,2,2],[1,1,1,1,1,1]]:3==t?h=[[1,2,2,2,2,1],[1,2,2,2,2,1],[1,2,4,4,2,1],[1,2,0,3,2,1],[1,1,1,1,1,1]]:4==t&&(h=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,4,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,2,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,2,0,0,0,1],[1,0,0,4,4,4,4,4,1,0,3,0,1,1,1,0,0,0,0,1],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],e.currentLevel=0);var i=h.length,n=h[0].length;for(row=0;row<i;row++)for(col=0;col<n;col++){var s;xx=32*col,yy=32*row;var a=h[row][col];a==BRICK||a==LEDGE||a==ICE?(s=new tileObj(32,xx,yy,a,!0,col,row,"none"),this.tiles.push(s)):a==COIN?(s=new tileObj(32,xx,yy,a,!1,col,row,"none"),this.coins.push(s),o++):a==HERO&&(this.startX=xx,this.startY=yy),.8<Math.random()&&(s=new tileObj(32,xx,yy,WALL,!1,col,row,"none"),this.backTiles.push(s))}null!=e&&e.resetPos(this.startX,this.startY),this.active=!0}}var level,hero,camera,debug=!1,offset=70,controllers=[],buttonsPressed=[],canvasW=800,canvasH=600;function startGame(){camera=new Camera(0,0),(level=new level(canvasW,canvasH,1)).reset(1),hero=new heroObj(25,25,"green",level.startX,level.startY),camera.newPos(hero,level),mainGame.start()}var mainGame={canvas:document.createElement("canvas"),start:function(){this.canvas.width=canvasW,this.canvas.height=canvasH,this.context=this.canvas.getContext("2d"),document.body.insertBefore(this.canvas,document.body.childNodes[0]),this.frameNo=0,this.interval=setInterval(updateGameArea,20),window.addEventListener("keydown",function(t){t.preventDefault(),mainGame.keys=mainGame.keys||[],mainGame.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){mainGame.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("mousedown",function(t){t.preventDefault(),mainGame.keys=mainGame.keys||[],mainGame.keys[t.button]=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),mainGame.keys=mainGame.keys||[],mainGame.keys[t.button]=!1}),this.canvas.oncontextmenu=function(t){t.preventDefault()},window.addEventListener("gamepadconnected",function(t){var e=navigator.getGamepads()[t.gamepad.index];console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.index,e.id,e.buttons.length,e.axes.length),controllers[t.gamepad.index]=t.gamepad})},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function updateGameArea(){navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads&&navigator.webkitGetGamepads,mainGame.clear(),level.draw(hero,camera),hero.tick(camera),hero.newPos(level.tiles),hero.update(camera),camera.newPos(hero,level)}var wall="assets/wall.png",brick="assets/brick.png",coin="assets/coin.png",ledge="assets/ledge.png",ice="assets/ice.png";function tileObj(t,e,i,n,s,a,h,r){this.entity=new entityObj(t,t,"null",e,i,"tile"),this.isSolid=s,this.column=a,this.row=h,this.color=r,this.image=new Image,this.collected=!1,this.type=n,this.active=!0,this.time=0;switch(this.type){case BRICK:this.image.src=brick;break;case COIN:this.image.src=coin;break;case LEDGE:this.image.src=ledge;break;case WALL:this.image.src=wall;break;case ICE:this.image.src=ice}this.update=function(t){ctx=mainGame.context,ctx.save(),ctx.translate(this.entity.x-t.entity.x,this.entity.y-t.entity.y),ctx.rotate(this.angle),null==this.image?(ctx.fillStyle=this.color,ctx.fillRect(this.mhWidth,this.mhHeight,this.entity.width,this.entity.height)):this.active&&ctx.drawImage(this.image,this.entity.mhWidth,this.entity.mhHeight,this.entity.width,this.entity.height),ctx.restore()},this.tick=function(t){this.type==ICE&&0<=this.entity.height&&heroOnIce()?(this.time+=.3,this.entity.height-=.3,this.entity.y+=.3):this.entity.height<=0&&(this.active=!1)}}function heroOnIce(t){return null!=t&&(hero.hbX<this.entity.x+this.entity.width&&hero.hbX>this.entity.x&&hero.hbY<this.entity.y+this.entity.height&&hero.hbY>this.entity.y)}function heroColliding(t){return hero.hbX<t.entity.x+t.entity.width&&hero.hbX>t.entity.x&&hero.hbY<t.entity.y+t.entity.height&&hero.hbY>t.entity.y}function rectColiding(t,e,i,n,s,a,h,r){return t<s+h&&s<t+i&&e<a+r&&a<e+n}