var e,h=[];function n(t,h){for(m=e.createBuffer(1,96e3,48e3),gainNode=e.createGain(),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=e.createBufferSource(),s.buffer=m,s.connect(gainNode),gainNode.connect(e.destination),gainNode.gain.value=.05,s.start()}function a(t){return 2*Math.random()-1}function o(t){if(t>1e4)return null;var i=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(i,2)}function y(t){if(t>5e4)return null;var i=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(i,3)}function r(t){var i=1e4;if(t>i)return null;var e=(i-t)/i,s=Math.pow(e,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?s:-s}function c(t){if(t>2e4)return null;var i=(2e4-t)/2e4;return Math.sin(.003*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*i*i}function l(){for(os of h)null!=os&&os.stop(0);for(d in h=[],data=[12,12,11,11,11,10,10,10,11,11,11,12,12,12],audio=new AudioContext,data)data[d]&&(gain=audio.createGain(),osc=audio.createOscillator(),h.push(osc),osc.connect(gain),gain.connect(audio.destination),osc.start(.4*d),osc.frequency.setValueAtTime(440*1.06**(13-data[d]),.4*d),osc.type="triangle",gain.gain.setValueAtTime(0,.4*d),gain.gain.setTargetAtTime(1e-4,.4*d+.38,.005),osc.stop(.4*d+.39))}function u(t,i){this.entity=new x(30,30,"null",t,i,"view"),this.newPos=function(t,i){this.entity.x=parseInt(t.entity.x+t.entity.width/2-i.canvasHalfW),this.entity.y=t.entity.y+t.entity.height/2-i.canvasHalfH-_}}function x(t,i,e,s,h,n){this.type=n,this.width=t,this.height=i,this.mhWidth=t/-2,this.mhHeight=i/-2,this.hWidth=t/2,this.hHeight=i/2,this.yOffset=0,this.angle=0,this.x=s,this.y=h,this.color=e,this.active=!0,this.update=function(){this.active&&(ctx=nt.context,ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(this.angle),ctx.fillStyle=this.color,ctx.fillRect(this.mhWidth,this.mhHeight,this.width,this.height),ctx.restore())}}function f(t,i,e,s){this.time=0,this.image=new Image,this.image.src=ot,this.direction=e;var h,n,a=t.gethPower();s=s;i==J&&(this.sx=30,this.sy=60,this.sw=8,this.sh=8,this.maxDuration=1,this.float=!0,this.floatAmount=3,this.grow=!0),e==v?h=t.entity.x-t.entity.hWidth:e==p&&(h=t.entity.x+t.entity.hWidth),n=t.entity.y+2*this.sh,this.entity=new x(this.sw,this.sh,null,h,n,i),this.tick=function(){this.entity.active&&(this.time+=.13,this.float&&(e==v?(this.entity.y-=this.floatAmount,this.entity.x-=this.floatAmount/2):e==p&&(this.entity.y-=this.floatAmount,this.entity.x+=this.floatAmount/2),this.grow&&(this.entity.width++,this.entity.height++),s?this.entity.x-=1.2*a:this.entity.x+=1.2*a),this.time>=this.maxDuration&&(this.entity.active=!1))},this.update=function(t){this.entity.active&&(ctx=nt.context,ctx.save(),ctx.globalAlpha=.65,ctx.translate(this.entity.x-t.entity.x,this.entity.y-t.entity.y),ctx.drawImage(this.image,this.sx,this.sy,this.sw,this.sh,this.entity.mhWidth,this.entity.mhHeight,this.entity.width,this.entity.height),ctx.restore())}}function g(e,s,h,a,o,y){this.entity=new x(e,s,h,a,o,"hero"),this.speed=1,this.color=h,this.startX=a,this.startY=o,this.currentLevel=0,this.active=!1,this.reset=!1,this.jumping=!1,this.onLadder=!1,this.exitLadder=!1,this.onLeftA=!1,this.onRightA=!1,this.image=new Image,this.image.src=ot,this.fx=[];var r=0,c=0,l=!1,d=6,u=!1,g=!1,w=0,m=0;function b(){Q.hbX=Q.entity.x+Q.entity.hWidth,Q.hbY=Q.entity.y+Q.entity.hHeight/2}this.update=function(t){for(ctx=nt.context,ctx.save(),ctx.translate(this.entity.x-t.entity.x,this.entity.y-t.entity.y),ctx.fillStyle=h,ctx.fillRect(this.entity.mhWidth,this.entity.mhHeight,this.entity.width,this.entity.height),ctx.restore(),i=0;i<this.fx.length;i++){var e=this.fx[i];e.tick(),e.update(t),0==e.entity.active&&this.fx.splice(i,1)}},this.newPos=function(e,s){w=0;var h=this.entity.y,a=this.falling;d=this.onLadder&&!this.exitLadder?0:6,this.hbX1=this.entity.x,this.hbY1=this.entity.y,b();var o=this.entity.x+r*this.speed,y=this.entity.y+d-c;this.onLeftA?(o-=3,r>3&&this.fx.length<10&&this.fx.push(new f(this,J,v,!0))):this.onRightA&&(o+=3,r<-3&&this.fx.length<10&&this.fx.push(new f(this,J,p,!0))),m>3.5&&(this.fx.push(new f(this,J,p,!0)),this.fx.push(new f(this,J,v,!0))),this.onLadder&&(u&&!this.exitLadder?(y-=3,u=!1,y+=c):g&&(y+=3,g=!1)),this.exitLadder=!1,c>0?c--:this.jumping=!1;var x=!0,k=!0;for(this.onLadder=!1,this.onLeftA=!1,this.onRightA=!1,i=0;i<e.length;i++)t=e[i],t.isSolid&&t.active&&dt(o,this.hbY1,this.entity.width,this.entity.height,t.entity.x,t.entity.y,t.entity.width,t.entity.height)&&(t.oneWay||(k=!1)),dt(this.hbX1,y,this.entity.width,this.entity.height,t.entity.x,t.entity.y,t.entity.width,t.entity.height)&&(t.isSolid&&t.active?t.oneWay?this.entity.y+this.entity.height<=t.entity.y&&(x=!1,this.jumping||(this.entity.y=t.entity.y-this.entity.height)):(x=!1,this.jumping||(this.entity.y=t.entity.y-this.entity.height)):t.type!=O&&t.type!=C||(this.onLadder=!0)),t.type==C?dt(this.hbX1,y+28,this.entity.width,this.entity.height,t.entity.x,t.entity.y,t.entity.width,t.entity.height)&&(this.exitLadder=!0,w=t.entity.y-y):t.type==N?dt(this.hbX1,y+10,this.entity.width,this.entity.height,t.entity.x,t.entity.y,t.entity.width,t.entity.height)&&(this.onLeftA=!0):t.type==B&&dt(this.hbX1,y+10,this.entity.width,this.entity.height,t.entity.x,t.entity.y,t.entity.width,t.entity.height)&&(this.onRightA=!0);l=!x,k&&(this.entity.x=o),x&&(this.entity.y=y),this.entity.y>400&&(n(z,1),this.entity.y=this.startY,this.entity.x=this.startX,s.reset(),this.reset=!0),this.falling=this.entity.y!=h,this.falling!=a&&l&&0==c&&(this.fx.push(new f(this,J,v,!1)),this.fx.push(new f(this,J,p,!1))),this.onLadder||this.exitLadder||l?m=0:m+=.1},this.tick=function(){r>0?(r-=.3)<0&&(r=0):r<0&&(r+=.3)>0&&(r=0),nt.keys&&!this.jumping&&(nt.keys[k]||nt.keys[A]||nt.keys[M])&&this.moveUp(),nt.keys&&(nt.keys[L]||nt.keys[P])&&this.onLadder&&(g=!0),nt.keys&&(nt.keys[v]||nt.keys[T])&&r>-3&&r--,nt.keys&&(nt.keys[p]||nt.keys[W])&&r<3&&r++,tt.length>0&&((tt[0].axes[0]<-.8||tt[0].axes[2]<-.8||tt[0].buttons[14].pressed)&&r>-3&&r--,(tt[0].axes[0]>.8||tt[0].axes[2]>.8||tt[0].buttons[15].pressed)&&r<3&&r++,(tt[0].axes[1]<-.8||tt[0].axes[3]<-.8||tt[0].buttons[12].pressed)&&this.moveUp(),(tt[0].axes[1]>.8||tt[0].axes[3]>.8||tt[0].buttons[13].pressed)&&this.onLadder&&(g=!0))},this.resetPos=function(t,i){this.startX=t,this.startY=i,this.entity.x=this.startX,this.entity.y=this.startY,b(),r=0,jumping=!1,c=0,this.active=!0,this.fx=[],m=0},this.updateHitbox=function(){b()},this.moveUp=function(){0==c&&(1==l||1==this.exitLadder&&w<=15)&&(this.jumping=!0,c=19,n(q,1)),this.onLadder&&(u=!0)},this.gethPower=function(){return r}}function w(){this.done=!1,this.introTime=0,this.tick=function(){nt.context.font="30px Arial",nt.context.fillText("Hello World",10,50),nt.context.fillText("Press Space",10,100),nt.keys&&nt.keys[M]&&(null==e&&(e=new AudioContext),ht=!0)},this.reset=function(){this.done=!1,this.introTime=0},this.trans=function(t,e){if(this.introTime<70){var s=t/32,h=e/32;if(this.introTime<32)for(i=0;i<=s;i++)for(j=0;j<=h;j++)ctx=nt.context,ctx.save(),ctx.translate(32*i,32*j),ctx.fillStyle="#2d1b00",ctx.fillRect(this.introTime/2,this.introTime/2,32-this.introTime,32-this.introTime),ctx.restore();this.introTime+=2}else this.done=!0}}getSound=function(t,i){var e;switch(t){case U:e=a(i);break;case V:e=r(i);break;case q:e=o(i);break;case z:e=y(i);break;case F:e=c(i);break;default:return 1}return e};var v=37,p=39,k=38,L=40,A=87,T=65,P=83,W=68,H=0,X=2,M=32,S=0,Y=1,I=2,G=3,R=4,D=5,O=6,C=7,E=8,N=9,B=10,U=0,V=1,q=2,z=3,F=4,J=0;function K(t,s,h){this.tiles=[],this.backTiles=[],this.coins=[],this.startX=0,this.startY=0,this.canvasHalfW=t/2,this.canvasHalfH=s/2,this.showPortal=!1,this.levels=[];var a,o=0,y=0;this.draw=function(t,e,s){for(i=0;i<this.backTiles.length;i++){(h=this.backTiles[i]).update(e)}for(i=0;i<this.tiles.length;i++){var h;(h=this.tiles[i]).update(e),s.done&&h.tick(t)}for(i=0;i<this.coins.length;i++){var a=this.coins[i];a.update(e),a.type==I&&lt(a)&&this.active&&a.active?(n(V,1),a.active=!1,o++):a.type==E&&this.showPortal&&(a.active?a.active&&lt(a)&&(n(F,1),this.showPortal=!1,t.currentLevel++,t.active=!1,this.active=!1,4==t.currentLevel&&(t.currentLevel=0),s.reset(),this.reset(t)):a.active=!0)}o!=y||t.reset?t.reset&&(this.showPortal=!1,t.reset=!1,t.active=!1,this.active=!1,s.reset(),this.reset(t)):this.showPortal=!0},this.reset=function(t){var i=null!=t?t.currentLevel:0;y=0,o=0,this.tiles=[],this.backTiles=[],this.coins=[];var s=(a=this.levels[i]).length,h=a[0].length;for(row=0;row<s;row++)for(col=0;col<h;col++){var n;xx=30*col,yy=30*row;var r=a[row][col];[Y,R,D,O,C,N,B].includes(r)?(n=new yt(30,xx,yy,r,!0,col,row,"none"),this.tiles.push(n)):r==I||r==E?(n=new yt(30,xx,yy,r,!1,col,row,"none"),this.coins.push(n),r==I&&y++):r==G&&(this.startX=xx,this.startY=yy),Math.random()>.8&&(n=new yt(30,xx,yy,S,!1,col,row,"none"),this.backTiles.push(n))}null!=t&&t.resetPos(this.startX,this.startY),null!=e&&l(),this.active=!0},this.levels.push([[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,6,1,9,9,9,1,0,0,0,7,0,0,0,0,0,0,0],[1,0,0,6,0,0,0,0,1,4,4,4,6,1,10,10,10,1,0,1],[1,0,0,6,0,0,0,0,1,0,0,0,6,1,0,2,0,0,0,1],[1,0,0,1,1,1,0,0,1,0,3,0,6,1,1,1,1,4,4,1],[1,0,0,0,0,0,0,0,1,0,0,8,0,0,0,0,0,0,2,1],[1,4,4,4,4,4,4,4,1,4,4,4,4,5,5,5,5,5,4,1]]),this.levels.push([[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,8,0],[0,3,0,0,2,2],[5,5,5,5,4,4]]),this.levels.push([[1,2,2,2,2,1],[1,2,2,2,2,1],[1,2,4,4,2,1],[1,2,8,3,2,1],[1,5,5,5,5,1]]),this.levels.push([[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,6,0],[0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,6,0],[0,0,0,0,0,0,0,0,1,4,0,0,0,0,0,0,0,0,6,0],[0,0,0,0,0,0,0,0,1,0,0,0,0,0,2,0,0,0,6,0],[1,0,0,0,0,0,0,0,1,1,1,0,0,1,1,1,0,0,6,1],[1,0,0,8,0,0,0,0,1,0,0,0,0,0,0,6,0,0,6,1],[1,0,0,4,4,4,4,4,1,0,3,0,1,1,1,6,0,0,6,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5]])}var K,Q,Z,$=!1,_=70,tt=[],it=[],et=600,st=400,ht=!1;function startGame(){Z=new u(0,0),(K=new K(et,st,1)).reset(null),Q=new g(25,25,"green",K.startX,K.startY),Z.newPos(Q,K),w=new w,nt.start()}this.introTime=0;var nt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=et,this.canvas.height=st,this.context=this.canvas.getContext("2d"),document.body.insertBefore(this.canvas,document.body.childNodes[4]),this.frameNo=0,this.interval=setInterval(at,20),window.addEventListener("keydown",function(t){t.preventDefault(),nt.keys=nt.keys||[],nt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){nt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("mousedown",function(t){t.preventDefault(),nt.keys=nt.keys||[],nt.keys[t.button]=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),nt.keys=nt.keys||[],nt.keys[t.button]=!1}),this.canvas.oncontextmenu=function(t){t.preventDefault()},window.addEventListener("gamepadconnected",function(t){var i=navigator.getGamepads()[t.gamepad.index];console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",i.index,i.id,i.buttons.length,i.axes.length),tt[t.gamepad.index]=t.gamepad})},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function at(){navigator.getGamepads?navigator.getGamepads():!navigator.webkitGetGamepads||navigator.webkitGetGamepads,ht?(nt.clear(),K.draw(Q,Z,w),w.done&&(Q.tick(Z),Q.newPos(K.tiles,w)),Q.update(Z),Z.newPos(Q,K),w.trans(et,st)):(nt.clear(),w.tick())}var ot="assets/atlas.png";function yt(t,i,e,s,h,n,a,o){this.entity=new x(t,t,"null",i,e,"tile"),this.isSolid=h,this.column=n,this.row=a,this.color=o,this.image=new Image,this.collected=!1,this.type=s,this.active=!0,this.time=0,this.oneWay=!1,this.leftPush=!1,this.rightPush=!1,this.image.src=ot,this.draw=!0,this.sx=0,this.sy=0,this.sw=30,this.sh=30;switch(this.type){case Y:this.sx=60;break;case I:this.sx=90;break;case O:this.sy=60,this.isSolid=!1;break;case C:this.draw=!1,this.isSolid=!1,this.entity.height=16,this.entity.y+=16;break;case R:this.sx=120,this.oneWay=!0;break;case S:this.sy=30;break;case D:this.time=1,this.sx=30,this.sy=30;break;case E:this.sx=60,this.sy=30,this.active=!1;break;case N:this.sx=0,this.sy=0,this.leftPush=!0;break;case B:this.sx=60,this.sy=30,this.rightPush=!0,this.entity.angle=2*Math.PI-180*Math.PI/180}this.update=function(t){ctx=nt.context,ctx.save(),ctx.translate(this.entity.x-t.entity.x,this.entity.y-t.entity.y),ctx.rotate(this.entity.angle),this.setTileAlphas(),this.animBelt(),null==this.image?(ctx.fillStyle=this.color,ctx.fillRect(this.mhWidth,this.mhHeight,this.entity.width,this.entity.height)):this.active&&this.draw&&(this.type==D?ctx.drawImage(this.image,this.sx,this.entity.yOffset,this.sw,this.sh,this.entity.mhWidth,this.entity.mhHeight+this.entity.yOffset,this.entity.width,this.entity.height):ctx.drawImage(this.image,this.sx,this.sy,this.sw,this.sh-1,this.entity.mhWidth,this.entity.mhHeight,this.entity.width,this.entity.height)),ctx.restore()},this.tick=function(t){this.type==D&&(this.entity.yOffset>-30&&rt(t,this)?(this.time-=.012,this.entity.yOffset-=.8):this.entity.yOffset<-30&&(this.active=!1))},this.animBelt=function(){this.type!=N&&this.type!=B||!this.active||(this.time+=.01,this.time<.2?(this.sx=120,this.sy=30):this.time<.4?(this.sx=90,this.sy=30):(this.sx=0,this.sy=0),this.time>.6&&(this.time=0))},this.setTileAlphas=function(){this.type==E&&this.active?(this.time+=.001,ctx.globalAlpha=ct(this.time)):this.type==D&&(ctx.globalAlpha=this.time)}}function rt(t,i){return null!=i.entity&&dt(t.entity.x,t.entity.y+20,t.entity.width,t.entity.height,i.entity.x,i.entity.y,i.entity.width,i.entity.height)}function ct(t){return.5*(1+Math.sin(157*t))}function lt(t){return Q.hbX<t.entity.x+t.entity.width&&Q.hbX>t.entity.x&&Q.hbY<t.entity.y+t.entity.height&&Q.hbY>t.entity.y}function dt(t,i,e,s,h,n,a,o){return t<h+a&&t+e>h&&i<n+o&&i+s>n}